{%- extends 'base.html' -%}

{%- block title -%}
{% if mbid == "" %}
  Track Details
{% else %}
  Track "{{ lowlevel.metadata.tags.title[0] }}" by {{ lowlevel.metadata.tags.artist[0] }}
{% endif %}
- AcousticBrainz
{%- endblock -%}

{%- block content -%}
  <h3>Details for track {{ mbid }}</h3>

  {%- if not metadata -%}
    <div class="alert alert-warning" role="alert">
      <strong>Metadata might be incorrect!</strong> We can't check it because MusicBrainz server is unavailable.
    </div>
  {%- endif -%}

  {%- if mbid -%}
    <div class="row">
      <div class="col-md-8">
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <th style="width: 30%;">Track information</th>
              <th>value</th>
            </tr>
          </thead>
          <tr>
            <td>artist</td>
            <td>
              {%- if metadata -%}
                {# TODO(roman): Handle multiple artists properly. #}
                {%- set artist_id = metadata['artist-credit'][0]['artist']['id'] -%}
                <a href="https://musicbrainz.org/artist/{{ artist_id }}">{{ metadata['artist-credit-phrase'] }}</a>
              {%- else -%}
                {%- if lowlevel.metadata.tags.musicbrainz_artistid -%}
                  <a href="https://musicbrainz.org/artist/{{ lowlevel.metadata.tags.musicbrainz_artistid[0] }}">
                    {{ lowlevel.metadata.tags.artist[0] }}
                  </a>
                  {%- else -%}
                    {{ lowlevel.metadata.tags.artist[0] }}
                  {%- endif -%}
              {%- endif -%}
            </td>
          </tr>
          <tr>
            <td>release</td>
            <td>
              {%- if metadata -%}
                {%- set release = metadata['release-list'][0] -%}
                <a href="https://musicbrainz.org/release/{{ release.id }}">{{ release.title }}</a>
              {%- else -%}
                {%- if lowlevel.metadata.tags.musicbrainz_albumid -%}
                  <a href="https://musicbrainz.org/release/{{ lowlevel.metadata.tags.musicbrainz_albumid[0] }}">
                    {{ lowlevel.metadata.tags.album[0] }}
                  </a>
                {%- else -%}
                  {{ lowlevel.metadata.tags.album[0] }}
                {%- endif -%}
              {%- endif -%}

              {# TODO(roman): Get MBID of release group from MusicBrainz. #}
              {% if lowlevel.metadata.tags.musicbrainz_releasegroupid %}
                <span class="critiquebrainz">(<a href="https://critiquebrainz.org/release-group/{{ lowlevel.metadata.tags.musicbrainz_releasegroupid[0] }}">Reviews at CritiqueBrainz</a>)</span>
              {% endif %}
            </td>
          </tr>
          <tr>
            <td>title</td>
            <td>
              <a href="https://musicbrainz.org/recording/{{ lowlevel.metadata.tags.musicbrainz_recordingid[0] }}">
                {{ metadata['title'] if metadata else lowlevel.metadata.tags.title[0] }}
              </a>
            </td>
          </tr>
          {% if lowlevel.metadata.tags.tracknumber %}
            <tr>
              <td>track number</td>
              <td>
                {%- if metadata -%}
                  {%- set medium = metadata['release-list'][0]['medium-list'][0] -%}
                  {{ medium['track-list'][0]['number'] }} / {{ medium['track-count'] }}
                {%- else -%}
                  {%- if lowlevel.metadata.tags.musicbrainz_albumid -%}
                    <a href="https://musicbrainz.org/release/{{ lowlevel.metadata.tags.musicbrainz_albumid[0] }}">
                      {{ lowlevel.metadata.tags.album[0] }}
                    </a>
                  {%- else -%}
                    {% if lowlevel.metadata.tags.tracktotal %}
                      {{ lowlevel.metadata.tags.tracknumber[0] }} / {{ lowlevel.metadata.tags.tracktotal[0] }}
                    {% else %}
                      {{ lowlevel.metadata.tags.tracknumber[0] }}
                    {% endif %}
                  {%- endif -%}
                {%- endif -%}
              </td>
            </tr>
          {% endif %}
          <tr>
            <td>track length</td>
            <td>{{ lowlevel.metadata.audio_properties.length_formatted }}</td></tr>
        </table>
      </div>

      <div class="col-md-4">
        {% if tomahawk_url %}
          <iframe src="{{ tomahawk_url }}" width="200" scrolling="no" height="200" frameborder="0" allowtransparency="true"></iframe>
        {% endif %}
      </div>
    </div>

    <table class="table table-striped table-bordered">
      <thead><tr><th style="width: 30%;">Tonal & Rhythm</th><th>value</th></tr></thead>
      <tr>
         <td><a href="http://essentia.upf.edu/documentation/reference/streaming_ChordsDescriptors.html">key</a></td>
         <td>{{ lowlevel.tonal.key_key }}</td>
      </tr>
      <tr>
         <td><a href="http://essentia.upf.edu/documentation/reference/streaming_ChordsDescriptors.html">scale</a></td>
         <td>{{ lowlevel.tonal.chords_scale }}</td>
      </tr>
      <tr>
         <td><a href="http://essentia.upf.edu/documentation/reference/streaming_Danceability.html">danceability</a></td>
         <td>{{ lowlevel.rhythm.danceability }}</td>
      </tr>
      <tr>
         <td><a href="http://essentia.upf.edu/documentation/reference/streaming_RhythmExtractor2013.html">bpm</a></td>
         <td>{{ lowlevel.rhythm.bpm }}</td></tr>
      <tr>
        <td>beat count</td>
        <td>{{ lowlevel.rhythm.beats_count }}</td>
      </tr>
    </table>

    {% if other %}
      <div class="col-md-12">
       <table class="table table-striped table-bordered">
          <thead><th style="width: 30%;">Voice, timbre, gender, etc.</th><th style="width: 25%;">value</th><th>probability</th></thead>
          {% for row in other %}
             <tr><td>{{ row[0] }}</td><td>{{ row[1] }}</td><td>{{ row[2] }}</td></tr>
          {% endfor %}
       </table>
      </div>

      <div class="col-md-12">
       <table class="table table-striped table-bordered">
          <thead><th style="width: 30%;">Moods</th><th style="width: 25%;">value</th><th>probability</th></thead>
          {% for row in moods %}
             <tr><td>{{ row[0] }}</td><td>{{ row[1] }}</td><td>{{ row[2] }}</td></tr>
          {% endfor %}
       </table>
      </div>

      <div class="col-md-12">
       <table class="table table-striped table-bordered">
          <thead><th style="width: 30%;">Genres</th><th style="width: 25%;">value</th><th>probability</th></thead>
          {% for row in genres %}
             <tr><td>{{ row[0] }}</td><td>{{ row[1] }}</td><td>{{ row[2] }}</td></tr>
          {% endfor %}
       </table>
      </div>
    {% else %}
      <div class="alert alert-warning">
        Sorry, we have not had a chance to calculate the high level data for
        this track yet. It should be calculated soon. In the meantime, have a
        look at our <a href="{{ url_for('data.data') }}#sample-data">sample data</a>.
      </div>
    {% endif %}

    <p>Inspect the data the above is taken from:</p>
    <ul>
      <li>
        <a href="{{ url_for('data.view_low_level', mbid=mbid) }}">Low level data</a>
        (<a href="{{ url_for('data.get_low_level', mbid=mbid) }}">raw JSON</a>)
      </li>
      {% if other -%}
        <li>
          <a href="{{ url_for('data.view_high_level', mbid=mbid) }}">High level data</a>
          (<a href="{{ url_for('data.get_high_level', mbid=mbid) }}">raw JSON</a>)
        </li>
      {%- endif %}
    </ul>

  {% endif %}
{%- endblock -%}
